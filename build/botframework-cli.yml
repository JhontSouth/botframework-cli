#
# Build Botframework-CLI on Windows agent
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(Build.BuildId)

pool:
  name: Hosted Windows 2019 with VS2019

pr:
  branches:
    include:
     - main

jobs:
  - job: CLI
    variables:
      runCodesignValidationInjection: false # Disables the unnecessary injected CodeSign Validation step
      buildVersion: '4.10.0-preview.$(Build.BuildId)'
      _version: ${{coalesce(variables.version, variables.buildVersion)}}

    steps:
    - task: colinsalmcorner.colinsalmcorner-buildtasks.tag-build-task.tagBuildOrRelease@0
      displayName: 'Tag Build with version number'
      inputs:
        tags: 'Version=$(_version)'
      continueOnError: true

    - task: NodeTool@0
      displayName: 'Use Node 18.x'
      inputs:
        versionSpec: 18.x

    - task: Npm@1
      displayName: 'npm install --global @microsoft/rush'
      inputs:
        command: custom
        verbose: false
        customCommand: 'install --global @microsoft/rush@5.33.0'

    - script: 'rush update'
      displayName: 'rush update'

    - script: 'rush build -p 2'
      displayName: 'rush build -p 2'
    
    - script: 'rush posttest'
      displayName: 'rush posttest'

    - script: 'node ./common/scripts/version-and-pack.js --version $(_version)'
      displayName: 'Version and Pack'

    - task: CopyFiles@2
      displayName: 'Copy packages to: $(Build.ArtifactStagingDirectory)/drop'
      inputs:
        SourceFolder: ./.output
        Contents: '**/*.tgz'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/drop'
        flattenFolders: true

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)/drop'
    artifact: 'pack'
    publishLocation: 'pipeline''
        ArtifactName: drop


